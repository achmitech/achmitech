<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ── Portal home: add entry for interim's own leaves ────────────────── -->
    <template id="portal_my_home_my_leaves"
              name="Portal: Mes absences"
              inherit_id="portal.portal_my_home"
              priority="30"
              customize_show="True">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="before">
            <t t-set="portal_client_category_enable" t-value="True"/>
        </xpath>
        <div id="portal_client_category" position="inside">
            <t t-if="is_interim">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Mes demandes de congé</t>
                    <t t-set="url" t-value="'/my/leaves'"/>
                    <t t-set="text">Soumettre et suivre vos demandes de congé.</t>
                    <t t-set="placeholder_count" t-value="'my_leaves_count'"/>
                    <t t-set="config_card" t-value="True"/>
                    <t t-set="icon" t-value="'/achmitech_portal_leaves/static/src/img/time_off.svg'"/>
                </t>
            </t>
        </div>
    </template>

    <!-- ── Portal home: add entry for team leaves ──────────────────────────── -->
    <template id="portal_my_home_team_leaves"
              name="Portal: Demandes de congés intérimaires"
              inherit_id="portal.portal_my_home"
              priority="30"
              customize_show="True">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="before">
            <t t-set="portal_client_category_enable" t-value="True"/>
        </xpath>
        <div id="portal_client_category" position="inside">
            <t t-if="is_client">
                <t t-call="portal.portal_docs_entry">
                    <t t-set="title">Demandes de congés</t>
                    <t t-set="url" t-value="'/my/team-leaves'"/>
                    <t t-set="text">Approuver ou refuser les demandes de congés de vos intérimaires.</t>
                    <t t-set="placeholder_count" t-value="'pending_leaves_count'"/>
                    <t t-set="count" t-value="pending_leaves_count or False"/>
                    <t t-set="bg_color" t-value="'alert alert-primary align-items-center' if pending_leaves_count else False"/>
                    <t t-set="config_card" t-value="True"/>
                    <t t-set="icon" t-value="'/achmitech_portal_leaves/static/src/img/time_off.svg'"/>
                </t>
            </t>
        </div>
    </template>

    <!-- ── List page: /my/team-leaves ──────────────────────────────────────── -->
    <template id="portal_team_leaves_list" name="Demandes de congés intérimaires">
        <t t-call="portal.portal_layout">

            <!-- Flash message -->
            <t t-if="flash">
                <div t-attf-class="alert alert-#{flash.get('type','info')} alert-dismissible fade show mb-3"
                     role="alert">
                    <t t-out="flash.get('message')"/>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"/>
                </div>
            </t>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">Demandes de congés de mes intérimaires</h3>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <a t-attf-class="nav-link #{'active' if active_tab != 'history' else ''}"
                       href="/my/team-leaves?tab=pending">
                        En attente
                        <t t-if="pending_count">
                            <span class="badge bg-warning text-dark ms-1">
                                <t t-out="pending_count"/>
                            </span>
                        </t>
                    </a>
                </li>
                <li class="nav-item">
                    <a t-attf-class="nav-link #{'active' if active_tab == 'history' else ''}"
                       href="/my/team-leaves?tab=history">
                        Historique
                    </a>
                </li>
            </ul>

            <!-- Searchbar -->
            <t t-call="portal.portal_searchbar">
                <t t-set="title">Demandes de congés</t>
            </t>

            <!-- ── Table (shared for both tabs) ────────────────────────────── -->
            <t t-if="not grouped_leaves or not grouped_leaves[0]">
                <div class="alert alert-info" role="alert">
                    <t t-if="active_tab != 'history'">
                        Aucune demande de congé en attente de votre approbation.
                    </t>
                    <t t-else="">
                        Aucun historique disponible.
                    </t>
                </div>
            </t>
            <t t-else="">
                <t t-foreach="grouped_leaves" t-as="group">
                    <!-- Group header (only when groupby is active) -->
                    <t t-if="groupby != 'none' and group">
                        <h6 class="mt-3 mb-1 text-muted fw-semibold border-bottom pb-1">
                            <t t-if="groupby == 'employee_id'">
                                <t t-out="group[0].employee_id.name"/>
                            </t>
                            <t t-elif="groupby == 'holiday_status_id'">
                                <t t-out="group[0].holiday_status_id.name"/>
                            </t>
                        </h6>
                    </t>

                    <div class="table-responsive mb-3">
                        <table class="table table-striped table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <t t-if="groupby != 'employee_id'">
                                        <th>Intérimaire</th>
                                    </t>
                                    <t t-if="groupby != 'holiday_status_id'">
                                        <th>Type de congé</th>
                                    </t>
                                    <th>Du</th>
                                    <th>Au</th>
                                    <th>Durée</th>
                                    <t t-if="active_tab != 'history'">
                                        <th>Délai de réponse</th>
                                        <th class="text-center">Actions</th>
                                    </t>
                                    <t t-else="">
                                        <th>Statut</th>
                                    </t>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="group" t-as="leave">
                                    <tr>
                                        <t t-if="groupby != 'employee_id'">
                                            <td><strong t-out="leave.employee_id.name"/></td>
                                        </t>
                                        <t t-if="groupby != 'holiday_status_id'">
                                            <td t-out="leave.holiday_status_id.name"/>
                                        </t>
                                        <td>
                                            <t t-out="leave.request_date_from"
                                               t-options='{"widget": "date"}'/>
                                        </td>
                                        <td>
                                            <t t-out="leave.request_date_to"
                                               t-options='{"widget": "date"}'/>
                                        </td>
                                        <td t-out="leave.duration_display"/>

                                        <!-- Pending columns -->
                                        <t t-if="active_tab != 'history'">
                                            <td>
                                                <t t-if="leave.client_deadline">
                                                    <span t-attf-class="badge #{'bg-danger' if leave.client_deadline &lt; today else 'bg-secondary'}">
                                                        <t t-out="leave.client_deadline"
                                                           t-options='{"widget": "date"}'/>
                                                    </span>
                                                </t>
                                            </td>
                                            <td class="text-center">
                                                <a t-attf-href="/my/team-leaves/#{leave.id}"
                                                   class="btn btn-sm btn-outline-primary me-1">
                                                    Détails
                                                </a>
                                                <form t-attf-action="/my/team-leaves/#{leave.id}/approve"
                                                      method="POST" class="d-inline">
                                                    <input type="hidden" name="csrf_token"
                                                           t-att-value="request.csrf_token()"/>
                                                    <button type="submit"
                                                            class="btn btn-sm btn-success"
                                                            onclick="return confirm('Confirmer l\'approbation ?')">
                                                        Approuver
                                                    </button>
                                                </form>
                                            </td>
                                        </t>

                                        <!-- History columns -->
                                        <t t-else="">
                                            <td>
                                                <t t-if="leave.state == 'validate'">
                                                    <span class="badge bg-success">Approuvée</span>
                                                </t>
                                                <t t-elif="leave.state == 'refuse'">
                                                    <span class="badge bg-danger">Refusée</span>
                                                    <t t-if="leave.client_refuse_reason">
                                                        <small class="text-muted ms-1">
                                                            — <t t-out="leave.client_refuse_reason"/>
                                                        </small>
                                                    </t>
                                                </t>
                                            </td>
                                        </t>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </t>

                <!-- Pager -->
                <t t-call="portal.pager"/>
            </t>

        </t>
    </template>

    <!-- ── Detail page: /my/team-leaves/<id> ──────────────────────────────── -->
    <template id="portal_team_leave_detail" name="Détail absence intérimaire">
        <t t-call="portal.portal_layout">

            <!-- Flash message -->
            <t t-if="flash">
                <div t-attf-class="alert alert-#{flash.get('type','info')} alert-dismissible fade show mb-3"
                     role="alert">
                    <t t-out="flash.get('message')"/>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"/>
                </div>
            </t>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">Demande de congé</h3>
                <a href="/my/team-leaves" class="btn btn-sm btn-outline-secondary">
                    ← Retour à la liste
                </a>
            </div>

            <!-- Leave details card -->
            <div class="card mb-4">
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Intérimaire</dt>
                        <dd class="col-sm-8">
                            <strong t-out="leave.employee_id.name"/>
                        </dd>

                        <dt class="col-sm-4">Type de congé</dt>
                        <dd class="col-sm-8" t-out="leave.holiday_status_id.name"/>

                        <dt class="col-sm-4">Date de début</dt>
                        <dd class="col-sm-8">
                            <t t-out="leave.request_date_from"
                               t-options='{"widget": "date"}'/>
                        </dd>

                        <dt class="col-sm-4">Date de fin</dt>
                        <dd class="col-sm-8">
                            <t t-out="leave.request_date_to"
                               t-options='{"widget": "date"}'/>
                        </dd>

                        <dt class="col-sm-4">Durée</dt>
                        <dd class="col-sm-8" t-out="leave.duration_display"/>

                        <t t-if="leave.name">
                            <dt class="col-sm-4">Motif</dt>
                            <dd class="col-sm-8" t-out="leave.name"/>
                        </t>

                        <t t-if="leave.client_deadline and leave.state == 'client_validate'">
                            <dt class="col-sm-4">Délai de réponse</dt>
                            <dd class="col-sm-8">
                                <t t-out="leave.client_deadline" t-options='{"widget": "date"}'/>
                            </dd>
                        </t>

                        <t t-if="leave.state == 'refuse' and leave.client_refuse_reason">
                            <dt class="col-sm-4">Motif de refus</dt>
                            <dd class="col-sm-8 text-danger" t-out="leave.client_refuse_reason"/>
                        </t>
                    </dl>
                </div>
            </div>

            <!-- Action buttons (only for pending leaves) -->
            <t t-if="leave.state == 'client_validate'">
                <div class="d-flex gap-2 flex-wrap">

                    <!-- Approve button -->
                    <form t-attf-action="/my/team-leaves/#{leave.id}/approve" method="POST">
                        <input type="hidden" name="csrf_token"
                               t-att-value="request.csrf_token()"/>
                        <button type="submit" class="btn btn-success"
                                onclick="return confirm('Confirmer l\'approbation de cette absence ?')">
                            Approuver le congé
                        </button>
                    </form>

                    <!-- Refuse button: opens modal with reason -->
                    <button type="button" class="btn btn-danger"
                            data-bs-toggle="modal" data-bs-target="#modal_refuse">
                        Refuser le congé
                    </button>

                </div>

                <!-- Refuse modal -->
                <div class="modal fade" id="modal_refuse" tabindex="-1"
                     aria-labelledby="modal_refuse_label" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form t-attf-action="/my/team-leaves/#{leave.id}/refuse" method="POST">
                                <input type="hidden" name="csrf_token"
                                       t-att-value="request.csrf_token()"/>
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modal_refuse_label">
                                        Refuser le congé
                                    </h5>
                                    <button type="button" class="btn-close"
                                            data-bs-dismiss="modal" aria-label="Close"/>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label class="form-label" for="refuse_reason">
                                            Motif du refus
                                            <span class="text-muted">(optionnel)</span>
                                        </label>
                                        <textarea name="reason" id="refuse_reason"
                                                  class="form-control" rows="3"
                                                  placeholder="Expliquez brièvement le motif du refus…"/>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                            data-bs-dismiss="modal">Annuler</button>
                                    <button type="submit" class="btn btn-danger">
                                        Confirmer le refus
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            </t>

            <!-- Read-only status for history -->
            <t t-elif="leave.state == 'validate'">
                <div class="alert alert-success">
                    Ce congé a été <strong>approuvé</strong>.
                </div>
            </t>
            <t t-elif="leave.state == 'refuse'">
                <div class="alert alert-danger">
                    Ce congé a été <strong>refusé</strong>.
                    <t t-if="leave.client_refuse_reason">
                        Motif : <em t-out="leave.client_refuse_reason"/>
                    </t>
                </div>
            </t>

        </t>
    </template>


    <!-- ── Interim list page: /my/leaves ────────────────────────────────────── -->
    <template id="portal_my_leaves_list" name="Mes absences">
        <t t-call="portal.portal_layout">

            <!-- Flash message -->
            <t t-if="flash">
                <div t-attf-class="alert alert-#{flash.get('type','info')} alert-dismissible fade show mb-3"
                     role="alert">
                    <t t-out="flash.get('message')"/>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"/>
                </div>
            </t>

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">Mes demandes de congé</h3>
                <button type="button" class="btn btn-primary btn-sm"
                        data-bs-toggle="modal" data-bs-target="#modal_new_leave">
                    + Nouvelle demande
                </button>
            </div>

            <!-- Leave list -->
            <t t-if="not leaves">
                <div class="alert alert-info" role="alert">
                    Vous n'avez aucune demande de congé enregistrée.
                </div>
            </t>
            <t t-else="">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Type de congé</th>
                                <th>Du</th>
                                <th>Au</th>
                                <th>Durée</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="leaves" t-as="leave">
                                <tr>
                                    <td t-out="leave.holiday_status_id.name"/>
                                    <td>
                                        <t t-out="leave.request_date_from"
                                           t-options='{"widget": "date"}'/>
                                    </td>
                                    <td>
                                        <t t-out="leave.request_date_to"
                                           t-options='{"widget": "date"}'/>
                                    </td>
                                    <td t-out="leave.duration_display"/>
                                    <td>
                                        <t t-if="leave.state == 'confirm'">
                                            <span class="badge bg-secondary">En cours de traitement</span>
                                        </t>
                                        <t t-elif="leave.state == 'client_validate'">
                                            <span class="badge bg-warning text-dark">En attente du client</span>
                                        </t>
                                        <t t-elif="leave.state in ('validate1', 'validate')">
                                            <span class="badge bg-success">Approuvée</span>
                                        </t>
                                        <t t-elif="leave.state == 'refuse'">
                                            <span class="badge bg-danger">Refusée</span>
                                            <t t-if="leave.client_refuse_reason">
                                                <small class="text-muted ms-1">
                                                    — <t t-out="leave.client_refuse_reason"/>
                                                </small>
                                            </t>
                                        </t>
                                        <t t-else="">
                                            <span class="badge bg-light text-dark">
                                                <t t-out="leave.state"/>
                                            </span>
                                        </t>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>
            </t>

            <!-- New leave modal -->
            <div class="modal fade" id="modal_new_leave" tabindex="-1"
                 aria-labelledby="modal_new_leave_label" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form action="/my/leaves/new" method="POST">
                            <input type="hidden" name="csrf_token"
                                   t-att-value="request.csrf_token()"/>
                            <div class="modal-header">
                                <h5 class="modal-title" id="modal_new_leave_label">
                                    Nouvelle demande de congé
                                </h5>
                                <button type="button" class="btn-close"
                                        data-bs-dismiss="modal" aria-label="Close"/>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label" for="leave_type_id">
                                        Type de congé <span class="text-danger">*</span>
                                    </label>
                                    <select name="leave_type_id" id="leave_type_id"
                                            class="form-select" required="required">
                                        <option value="">— Choisir un type —</option>
                                        <t t-foreach="leave_types" t-as="lt">
                                            <option t-att-value="lt.id" t-out="lt.name"/>
                                        </t>
                                    </select>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label" for="date_from">
                                            Date de début <span class="text-danger">*</span>
                                        </label>
                                        <input type="date" name="date_from" id="date_from"
                                               class="form-control" required="required"/>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label" for="date_to">
                                            Date de fin <span class="text-danger">*</span>
                                        </label>
                                        <input type="date" name="date_to" id="date_to"
                                               class="form-control" required="required"/>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" for="leave_name">
                                        Motif <span class="text-muted">(optionnel)</span>
                                    </label>
                                    <textarea name="name" id="leave_name"
                                              class="form-control" rows="2"
                                              placeholder="Précisez si nécessaire…"/>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Annuler</button>
                                <button type="submit" class="btn btn-primary">
                                    Soumettre la demande
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </t>
    </template>

</odoo>
