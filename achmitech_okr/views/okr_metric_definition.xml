<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <record id="view_okr_metric_definition_tree" model="ir.ui.view">
    <field name="name">okr.metric.definition.tree</field>
    <field name="model">okr.metric.definition</field>
    <field name="arch" type="xml">
      <list open_form_view="True" delete="1">
        <field name="name" string="Intitulé"/>
        <field name="definition_type" string="Type d'indicateur"/>
        <field name="predefined_kpi" string="KPI prédéfini" invisible="definition_type != 'predefined'"/>
        <field name="model_id" string="Modèle" invisible="definition_type != 'domain'"/>
        <field name="aggregation" string="Methode d'agrégation" invisible="definition_type != 'domain'"/>
        <field name="value_field_id" string="Champ de valeur" invisible="definition_type != 'domain' or aggregation == 'count'"/>
        <field name="active" invisible="1"/>
      </list>
    </field>
  </record>

  <record id="view_okr_metric_definition_form" model="ir.ui.view">
    <field name="name">okr.metric.definition.form</field>
    <field name="model">okr.metric.definition</field>
    <field name="priority" eval="1000"/>
    <field name="arch" type="xml">
        <form string="Définition d'Indicateur OKR">
            <sheet>
                <!-- Basic -->
                <group>
                    <field name="name" string="Intitulé"/>
                    <field name="definition_type" string="Type d'indicateur"/>
                    <field name="active" invisible="1"/>
                </group>

                <!-- ===================== -->
                <!-- DOMAIN MODE -->
                <!-- ===================== -->

                <group string="Configuration Domaine"
                        invisible="definition_type != 'domain'">

                    <group>
                        <field name="model_id" string="Modèle" options="{'no_create': True}"/>
                        <field name="model_name" invisible="1"/>
                        <field name="aggregation" string="Agrégation"/>
                        <field name="value_field_id"
                            string="Champ de valeur"
                            invisible="aggregation == 'count'"
                            options="{'no_create': True}"/>
                    </group>

                    <separator string="Filtre (Domaine)"/>

                    <group>
                        <field name="domain"
                                string="Domaine"
                                widget="domain"
                                options="{'model': 'model_name'}"/>
                    </group>
                    <group>
                        <div class="alert alert-info" role="alert">
                            Utilisez uniquement des champs du modèle pour construire le filtre.
                            Les variables contextuelles (société, utilisateur, période) sont injectées
                            automatiquement côté serveur lors du calcul de l'indicateur.
                        </div>
                    </group>
                </group>

                <!-- ===================== -->
                <!-- PREDEFINED KPI MODE -->
                <!-- ===================== -->

                <group string="Indicateur Prédéfini"
                        invisible="definition_type != 'predefined'">

                    <group>
                        <field name="predefined_kpi" string="KPI prédéfini"/>
                    </group>

                    <div class="alert alert-success" role="alert">
                        Ce KPI utilise un calcul Python prédéfini.
                        Aucun domaine ou modèle n'est nécessaire.
                    </div>
                </group>

                <!-- ===================== -->
                <!-- CUSTOM CODE MODE -->
                <!-- ===================== -->

                <group string="Code Python Personnalisé"
                        invisible="definition_type != 'code'">

                    <field name="python_code"
                        string="Code Python"
                        class="w-50" widget="code" options="{'mode': 'python'}"/>
                </group>

            </sheet>
      </form>
    </field>
</record>

  <record id="action_okr_metric_definition" model="ir.actions.act_window">
    <field name="name">Définition d'Indicateur OKRs</field>
    <field name="res_model">okr.metric.definition</field>
    <field name="view_mode">list,form</field>
  </record>

</odoo>
